//
//  MyProfileInteractorTests.swift
//  Travelling
//
//  Created by Dimitri Strauneanu on 27/09/2020.
//  Copyright (c) 2020 Travelling. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

@testable import Travelling
import XCTest

class MyProfileInteractorTests: XCTestCase {
    var sut: MyProfileInteractor!
    var presenterSpy: MyProfilePresentationLogicSpy!
    var workerSpy: MyProfileWorkerSpy!
    var emailHandlerSpy: EmailHandlerSpy!
    var userDefaultsManagerSpy: UserDefaultsManagerSpy!
  
    // MARK: - Test lifecycle
  
    override func setUp() {
        super.setUp()
        self.setupMyProfileInteractor()
    }
  
    override func tearDown() {
        super.tearDown()
    }
  
    // MARK: - Test setup
  
    func setupMyProfileInteractor() {
        self.sut = MyProfileInteractor()
        
        self.presenterSpy = MyProfilePresentationLogicSpy()
        self.sut.presenter = self.presenterSpy
        
        self.workerSpy = MyProfileWorkerSpy(delegate: self.sut)
        self.sut.worker = self.workerSpy
        
        self.emailHandlerSpy = EmailHandlerSpy()
        self.sut.emailHandler = self.emailHandlerSpy
        
        self.userDefaultsManagerSpy = UserDefaultsManagerSpy()
        self.sut.userDefaultsManager = self.userDefaultsManagerSpy
    }
    
    // MARK: - Setup user tests
    
    func testShouldSetupUserShouldAskThePresenterToPresentRemoveErrorState() {
        self.sut.shouldSetupUser()
        XCTAssertTrue(self.presenterSpy.presentRemoveErrorStateCalled)
    }
    
    func testShouldSetupUserShouldAskThePresenterToPresentUserWhenThereIsUser() {
        self.sut.user = User(id: "userId")
        self.sut.shouldSetupUser()
        XCTAssertTrue(self.presenterSpy.presentUserCalled)
    }
    
    // MARK: - Fetch user tests
    
    func testSuccessDidFetchUserShouldUpdateIsFetchingUserFlag() {
        self.sut.isFetchingUser = true
        self.sut.successDidFetchUser(user: User(id: "userId"))
        XCTAssertFalse(self.sut.isFetchingUser)
    }
    
    func testSuccessDidFetchUserShouldUpdateUser() {
        self.sut.user = nil
        let user = User(id: "userId")
        self.sut.successDidFetchUser(user: user)
        XCTAssertEqual(self.sut.user, user)
    }
    
    func testSuccessDidFetchUserShouldAskThePresenterToPresentUser() {
        self.sut.successDidFetchUser(user: User(id: "userId"))
        XCTAssertTrue(self.presenterSpy.presentUserCalled)
    }
    
    func testSuccessDidFetchUserShouldAskThePresenterToPresentRemoveErrorState() {
        self.sut.successDidFetchUser(user: User(id: "userId"))
        XCTAssertTrue(self.presenterSpy.presentRemoveErrorStateCalled)
    }
    
    func testSuccessDidFetchUserShouldAskThePresenterToPresentDidFetchUser() {
        self.sut.successDidFetchUser(user: User(id: "userId"))
        XCTAssertTrue(self.presenterSpy.presentDidFetchUserCalled)
    }
    
    func testFailureDidFetchUserShouldUpdateIsFetchingUserFlag() {
        self.sut.isFetchingUser = true
        self.sut.failureDidFetchUser(error: OperationError.noDataAvailable)
        XCTAssertFalse(self.sut.isFetchingUser)
    }
    
    func testFailureDidFetchUserShouldAskThePresenterToPresentErrorState() {
        self.sut.failureDidFetchUser(error: OperationError.noDataAvailable)
        XCTAssertTrue(self.presenterSpy.presentErrorStateCalled)
    }
    
    func testFailureDidFetchUserShouldAskThePresenterToPresentDidFetchUser() {
        self.sut.failureDidFetchUser(error: OperationError.noDataAvailable)
        XCTAssertTrue(self.presenterSpy.presentDidFetchUserCalled)
    }
    
    // MARK: - Refresh user tests
        
    func testShouldRefreshUserShouldUpdateIsFetchingUserFlag() {
        self.sut.isFetchingUser = false
        self.sut.shouldRefreshUser()
        XCTAssertTrue(self.sut.isFetchingUser)
    }
    
    func testShouldRefreshUserShouldAskThePresenterToPresentResetUser() {
        self.sut.isFetchingUser = false
        self.sut.shouldRefreshUser()
        XCTAssertTrue(self.presenterSpy.presentResetUserCalled)
    }
    
    func testShouldRefreshUserShouldAskThePresenterToPresentRemoveErrorState() {
        self.sut.isFetchingUser = false
        self.sut.shouldRefreshUser()
        XCTAssertTrue(self.presenterSpy.presentRemoveErrorStateCalled)
    }
  
    func testShouldRefreshUserShouldAskThePresenterToPresentWillFetchUser() {
        self.sut.isFetchingUser = false
        self.sut.shouldRefreshUser()
        XCTAssertTrue(self.presenterSpy.presentWillFetchUserCalled)
    }
    
    func testShouldRefreshUserShouldAskTheWorkerToFetchUser() {
        self.sut.isFetchingUser = false
        self.sut.shouldRefreshUser()
        XCTAssertTrue(self.workerSpy.fetchUserCalled)
    }
    
    // MARK: - Fetch image tests
    
    func testShouldFetchImageShouldAskThePresenterToPresentPlaceholderImageWhenThereIsNoImageAndImageName() {
        let model = MyProfileModels.UserModel()
        model.image = nil
        model.imageName = nil
        self.sut.shouldFetchImage(request: MyProfileModels.ImageFetching.Request(model: model))
        XCTAssertTrue(self.presenterSpy.presentPlaceholderImageCalled)
    }
    
    func testShouldFetchImageShouldAskThePresenterToPresentPlaceholderImageWhenThereIsNoImageAndEmptyImageName() {
        let model = MyProfileModels.UserModel()
        model.image = nil
        model.imageName = ""
        self.sut.shouldFetchImage(request: MyProfileModels.ImageFetching.Request(model: model))
        XCTAssertTrue(self.presenterSpy.presentPlaceholderImageCalled)
    }
    
    func testShouldFetchImageShouldAskThePresenterToPresentWillFetchImageWhenThereIsNoImageAndIsNotLoading() {
        let model = MyProfileModels.UserModel()
        model.image = nil
        model.imageName = "imageName"
        model.isLoadingImage = false
        self.sut.shouldFetchImage(request: MyProfileModels.ImageFetching.Request(model: model))
        XCTAssertTrue(self.presenterSpy.presentWillFetchImageCalled)
    }
    
    func testShouldFetchImageShouldAskTheWorkerToFetchImageWhenThereIsNoImageAndIsNotLoading() {
        let model = MyProfileModels.UserModel()
        model.image = nil
        model.imageName = "imageName"
        model.isLoadingImage = false
        self.sut.shouldFetchImage(request: MyProfileModels.ImageFetching.Request(model: model))
        XCTAssertTrue(self.workerSpy.fetchImageCalled)
    }
    
    func testSuccessDidFetchImageShouldAskThePresenterToPresentImage() {
        self.sut.successDidFetchImage(model: MyProfileModels.UserModel(), image: nil)
        XCTAssertTrue(self.presenterSpy.presentImageCalled)
    }
    
    func testSuccessDidFetchImageShouldAskThePresenterToPresentDidFetchImage() {
        self.sut.successDidFetchImage(model: MyProfileModels.UserModel(), image: nil)
        XCTAssertTrue(self.presenterSpy.presentDidFetchImageCalled)
    }
    
    func testFailureDidFetchImageShouldAskThePresenterToPresentPlaceholderImage() {
        self.sut.failureDidFetchImage(model: MyProfileModels.UserModel(), error: .noDataAvailable)
        XCTAssertTrue(self.presenterSpy.presentPlaceholderImageCalled)
    }
    
    func testFailureDidFetchImageShouldAskThePresenterToPresentDidFetchImage() {
        self.sut.failureDidFetchImage(model: MyProfileModels.UserModel(), error: .noDataAvailable)
        XCTAssertTrue(self.presenterSpy.presentDidFetchImageCalled)
    }
    
    // MARK: - Select item tests
    
    func testShouldSelectItemShouldAskThePresenterToPresentWillLogoutUserForLogoutItemType() {
        self.sut.shouldSelectItem(request: MyProfileModels.ItemSelection.Request(type: .logout))
        XCTAssertTrue(self.presenterSpy.presentWillLogoutUserCalled)
    }
    
    func testShouldSelectItemShouldAskTheWorkerToLogoutUserForLogoutItemType() {
        self.sut.shouldSelectItem(request: MyProfileModels.ItemSelection.Request(type: .logout))
        XCTAssertTrue(self.workerSpy.logoutUserCalled)
    }
    
    // MARK: - Login tests
    
    func testShouldLoginUserShouldSetUser() {
        self.sut.user = nil
        let user = User(id: "userId")
        self.sut.shouldLoginUser(request: MyProfileModels.UserLogin.Request(user: user))
        XCTAssertEqual(self.sut.user, user)
    }
    
    func testShouldLoginUserShouldAskThePresenterToPresentRemoveErrorState() {
        self.sut.shouldLoginUser(request: MyProfileModels.UserLogin.Request(user: User(id: "id")))
        XCTAssertTrue(self.presenterSpy.presentRemoveErrorStateCalled)
    }
    
    func testShouldLoginUserShouldAskThePresenterToPresentUser() {
        self.sut.shouldLoginUser(request: MyProfileModels.UserLogin.Request(user: User(id: "id")))
        XCTAssertTrue(self.presenterSpy.presentUserCalled)
    }
    
    // MARK: - Logout tests
    
    func testShouldLogoutUserShouldRemoveUser() {
        self.sut.user = User(id: "userId")
        self.sut.shouldLogoutUser()
        XCTAssertNil(self.sut.user)
    }
    
    func testShouldLogoutUserShouldAskThePresenterToPresentResetUser() {
        self.sut.shouldLogoutUser()
        XCTAssertTrue(self.presenterSpy.presentResetUserCalled)
    }
    
    func testSuccessDidLogoutUserShouldAskThePresenterToPresentLoggedOutUser() {
        self.sut.successDidLogoutUser(userId: "userId")
        XCTAssertTrue(self.presenterSpy.presentLoggedOutUserCalled)
    }
    
    func testSuccessDidLogoutUserShouldAskThePresenterToPresentDidLogoutUser() {
        self.sut.successDidLogoutUser(userId: "userId")
        XCTAssertTrue(self.presenterSpy.presentDidLogoutUserCalled)
    }
    
    func testFailureDidLogoutUserShouldAskThePresenterToPresentErrorAlert() {
        self.sut.failureDidLogoutUser(error: OperationError.noDataAvailable)
        XCTAssertTrue(self.presenterSpy.presentErrorAlertCalled)
    }
    
    func testFailureDidLogoutUserShouldAskThePresenterToPresentDidLogoutUser() {
        self.sut.failureDidLogoutUser(error: OperationError.noDataAvailable)
        XCTAssertTrue(self.presenterSpy.presentDidLogoutUserCalled)
    }
    
    // MARK: - Report issue tests
    
    func testShouldNavigateToEmailShouldAskThePresenterToPresentNavigateToReportIssue() {
        self.emailHandlerSpy.canSendEmailValue = true
        self.sut.shouldSelectItem(request: MyProfileModels.ItemSelection.Request(type: .reportIssue))
        XCTAssertTrue(self.presenterSpy.presentNavigateToReportIssueCalled)
    }
    
    // MARK: - Select avatar tests
    
    func testShouldSelectAvatarShouldAskThePresenterToPresentNavigateToFullscreenImage() {
        self.sut.shouldSelectAvatar()
        XCTAssertTrue(self.presenterSpy.presentNavigateToFullscreenImageCalled)
    }
}
