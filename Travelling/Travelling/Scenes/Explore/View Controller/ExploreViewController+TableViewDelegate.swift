//
//  ExploreViewController+TableViewDelegate.swift
//  Travelling
//
//  Created by Dimitri Strauneanu on 13/09/2020.
//  Copyright (c) 2020 Travelling. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

extension ExploreViewController: UITableViewDelegate {
    func scrollViewDidScroll(_ scrollView: UIScrollView) {
        if scrollView.shouldLoadMoreBeforeReaching(threshold: 50) {
            self.interactor?.shouldFetchItems()
        }
    }
    
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let item = self.sections[indexPath.section].items[indexPath.row]
        self.interactor?.shouldNavigateToPlaceDetails(request: ExploreModels.ItemNavigation.Request(id: item.id))
    }
    
    func tableView(_ tableView: UITableView, viewForHeaderInSection section: Int) -> UIView? {
        if self.sections[section].isLoading {
            return self.loadingHeaderFooterView(tableView: tableView, isLoading: self.sections[section].isLoading)
        } else if self.sections[section].hasError {
            return self.errorHeaderFooterView(tableView: tableView, title: self.sections[section].errorText)
        } else if self.sections[section].noMoreItems {
            return self.titleHeaderFooterView(tableView: tableView, title: self.sections[section].noMoreItemsText)
        }
        return nil
    }
    
    public func tableView(_ tableView: UITableView, estimatedHeightForHeaderInSection section: Int) -> CGFloat {
        if self.sections[section].isLoading {
            return UITableView.automaticDimension
        } else if self.sections[section].hasError {
            return UITableView.automaticDimension
        } else if self.sections[section].noMoreItems {
            return UITableView.automaticDimension
        }
        return 0
    }
    
    public func tableView(_ tableView: UITableView, viewForFooterInSection section: Int) -> UIView? {
        return UIView()
    }
    
    public func tableView(_ tableView: UITableView, estimatedHeightForFooterInSection section: Int) -> CGFloat {
        switch section {
            case ExploreModels.SectionIndex.items.rawValue: return ExploreStyle.shared.tableViewModel.itemsSectionFooterHeight
            case ExploreModels.SectionIndex.footer.rawValue: return ExploreStyle.shared.tableViewModel.footerSectionFooterHeight
            default: return CGFloat.leastNonzeroMagnitude
        }
    }
    
    private func loadingHeaderFooterView(tableView: UITableView, isLoading: Bool) -> TableViewLoadingHeaderFooterView {
        let view = tableView.dequeueReusableHeaderFooterView(withIdentifier: TableViewLoadingHeaderFooterView.defaultReuseIdentifier) as? TableViewLoadingHeaderFooterView ?? TableViewLoadingHeaderFooterView()
        view.setColor(color: ExploreStyle.shared.tableViewModel.activityIndicatorColor)
        view.setIsLoading(isLoading: isLoading)
        return view
    }
    
    private func titleHeaderFooterView(tableView: UITableView, title: NSAttributedString?) -> TableViewTitleHeaderFooterView {
        let view = tableView.dequeueReusableHeaderFooterView(withIdentifier: TableViewTitleHeaderFooterView.defaultReuseIdentifier) as? TableViewTitleHeaderFooterView ?? TableViewTitleHeaderFooterView()
        view.setTitle(title: title)
        return view
    }
    
    private func errorHeaderFooterView(tableView: UITableView, title: NSAttributedString?) -> TableViewErrorHeaderFooterView {
        let view = tableView.dequeueReusableHeaderFooterView(withIdentifier: TableViewErrorHeaderFooterView.defaultReuseIdentifier) as? TableViewErrorHeaderFooterView ?? TableViewErrorHeaderFooterView()
        view.setTitle(title: title)
        view.delegate = self
        return view
    }
}

extension ExploreViewController: TableViewErrorHeaderFooterViewDelegate {
    func tableViewErrorHeaderFooterView(view: TableViewErrorHeaderFooterView?, didSelectTitle button: UIButton?) {
        self.interactor?.shouldFetchItems()
    }
}
